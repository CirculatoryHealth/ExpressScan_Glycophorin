---
title: "Express Scan - preparation of data"
author:
- Joost M. Mekke
- MD
mainfont: Helvetica
output:
  html_notebook:
    cache: yes
    code_folding: hide
    collapse: yes
    df_print: paged
    fig.align: center
    fig_caption: yes
    fig_height: 10
    fig_retina: 2
    fig_width: 12
    theme: paper
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
  html_document:
    df_print: paged
    toc: yes
subtitle: An 'Express Scan' project
editor_options:
  chunk_output_type: inline
---
```{r Libraries used, include = FALSE}
library(haven)
library(foreign)
library(RColorBrewer)
library(ggpubr)
library(ggplot2)
library(magrittr)
library(tableone)
library(patchwork)
library(data.table)
library(tidyverse)
library(car)
require(labelled)
library(plyr)
library(survminer)
library(survival)
library(dplyr)
library(Hmisc)
library(openxlsx)
library(lubridate)
library(mice)
library(randomForest)
library(sjlabelled)
library(miceadds)

set.seed(145) # We have to use set.seed() to ensure that we reproduce the same results at different time of execution. When we generate randoms numbers without set. seed() function it will produce different samples at different time of execution and with imputation, we are generating random numbers.
# Link:https://www.datasciencemadesimple.com/generate-sample-set-seed-function-r/#:~:text=seed()%20function%20in%20R%20and%20why%20to%20use%20it,at%20different%20time%20of%20execution
```
# Creating a dataset to use for imputing
```{r}
# Creating seperate dataset for imputing
ES_imputing <- ExpressScan %>%
  dplyr::select(STUDY_NUMBER,Age,ORdate_epoch,systolic, diastoli, TC_final, LDL_final, HDL_final, TG_final, BMI, GFR_MDRD, Gender, Hospital,Hypertension.selfreport,Hypertension.drugs,DiabetesStatus,risk614,Med.anticoagulants,Med.all.antiplatelet,Med.Statin.LLD,SmokerStatus,CAD_history,PAOD,
StrokeTIA_history,Peripheral.interv,Stenosis_ipsilateral,indexsymptoms_latest_4g, asympt_sympt_latest, stenosis_con_bin, SourceCD34, SourceCD68, SourceSMA, SourceHE, SourceEVG, Total_CD34_TissueCount_rank,Total_CD66b_TissueCount_rank,Total_CD68_TissueCount_rank,Total_SMA_TissueCount_rank,Total_HE_TissueCount_rank,Total_EVG_Tissue_rank, Total_GLYCC_Tissue_rank, PlaquesizeCD34_rank, PlaquesizeCD66b_rank,PlaquesizeCD68_rank, PlaquesizeSMA_rank, PlaquesizeHE_rank, PlaquesizeEVG_rank, PlaquesizeGlycc_rank, ep_major_t_3years, epmajor.3years, IPH.bin)

# Correcting missings
ES_imputing[ES_imputing==-999.000]<-NA
ES_imputing[ES_imputing==-999]<- NA
ES_imputing[ES_imputing==999] <- NA
ES_imputing[ES_imputing==-888] <- NA
ES_imputing[ES_imputing==-998] <- NA
ES_imputing[ES_imputing==-997] <- NA


## Transform variables for regression
### TC_final (mg/dL)
attach(ES_imputing)
min_TC_final <- min(ES_imputing$TC_final, na.rm = TRUE)
min_TC_final
ES_imputing$TC_final_LN <- log(ES_imputing$TC_final + min_TC_final)

### LDL_final (mg/dL)
ES_imputing$LDL_final[ES_imputing$LDL_final==0.000] <- NA
min_LDL_final <- min(ES_imputing$LDL_final, na.rm = TRUE)
min_LDL_final
ES_imputing$LDL_final_LN <- log(ES_imputing$LDL_final + min_LDL_final)

### HDL_final (mg/dL)
min_HDL_final <- min(ES_imputing$HDL_final, na.rm = TRUE)
min_HDL_final
ES_imputing$HDL_final_LN <- log(ES_imputing$HDL_final + min_HDL_final)
summary(ES_imputing$TC_final_LN)

### TG_final (mg/dL)
min_TG_final <- min(ES_imputing$TG_final, na.rm = TRUE)
min_TG_final
ES_imputing$TG_final_LN <- log(ES_imputing$TG_final + min_TG_final)

### BMI (kg/m²)
min_BMI <- min(ES_imputing$BMI, na.rm = TRUE)
min_BMI
ES_imputing$BMI_LN <- log(ES_imputing$BMI + min_BMI)

### ep_major_t_3years
ES_imputing$ep_major_t_3years_LN <- log(ES_imputing$ep_major_t_3years + 0.01)
detach(ES_imputing)

# Baseline variables (Continuous variables)
ES_imputing$STUDY_NUMBER <- as.numeric(ES_imputing$STUDY_NUMBER)
ES_imputing$Age <- as.numeric(ES_imputing$Age)
ES_imputing$ORdate_epoch <- as.numeric(ES_imputing$ORdate_epoch)
ES_imputing$systolic <- as.numeric(ES_imputing$systolic)
ES_imputing$diastoli <- as.numeric(ES_imputing$diastoli)
ES_imputing$TC_final_LN <- as.numeric(ES_imputing$TC_final_LN)
ES_imputing$LDL_final_LN <- as.numeric(ES_imputing$LDL_final_LN)
ES_imputing$HDL_final_LN <- as.numeric(ES_imputing$HDL_final_LN)
ES_imputing$TG_final_LN <- as.numeric(ES_imputing$TG_final_LN)
ES_imputing$TC_final <- as.numeric(ES_imputing$TC_final)
ES_imputing$LDL_final <- as.numeric(ES_imputing$LDL_final)
ES_imputing$HDL_final <- as.numeric(ES_imputing$HDL_final)
ES_imputing$TG_final <- as.numeric(ES_imputing$TG_final)
ES_imputing$BMI_LN <- as.numeric(ES_imputing$BMI_LN)
ES_imputing$BMI <- as.numeric(ES_imputing$BMI)
ES_imputing$GFR_MDRD <- as.numeric(ES_imputing$GFR_MDRD)
ES_imputing$ep_major_t_3years <- as.numeric(ES_imputing$ep_major_t_3years)
ES_imputing$ep_major_t_3years_LN <- as.numeric(ES_imputing$ep_major_t_3years_LN)

# Plaque characteristics (Continuous variables)
ES_imputing$Total_CD34_TissueCount_rank <- as.numeric(ES_imputing$Total_CD34_TissueCount_rank)
ES_imputing$Total_CD66b_TissueCount_rank <- as.numeric(ES_imputing$Total_CD66b_TissueCount_rank)
ES_imputing$Total_CD68_TissueCount_rank <- as.numeric(ES_imputing$Total_CD68_TissueCount_rank)
ES_imputing$Total_SMA_TissueCount_rank <- as.numeric(ES_imputing$Total_SMA_TissueCount_rank)
ES_imputing$Total_HE_TissueCount_rank <- as.numeric(ES_imputing$Total_HE_TissueCount_rank)
ES_imputing$Total_EVG_Tissue_rank <- as.numeric(ES_imputing$Total_EVG_Tissue_rank)
ES_imputing$Total_GLYCC_Tissue_rank <- as.numeric(ES_imputing$Total_GLYCC_Tissue_rank)

# Plaque sizes (Continuous variables)
ES_imputing$PlaquesizeCD34_rank <- as.numeric(ES_imputing$PlaquesizeCD34_rank)
ES_imputing$PlaquesizeCD66b_rank <- as.numeric(ES_imputing$PlaquesizeCD66b_rank)
ES_imputing$PlaquesizeCD68_rank <- as.numeric(ES_imputing$PlaquesizeCD68_rank)
ES_imputing$PlaquesizeSMA_rank <- as.numeric(ES_imputing$PlaquesizeSMA_rank)
ES_imputing$PlaquesizeHE_rank <- as.numeric(ES_imputing$PlaquesizeHE_rank)
ES_imputing$PlaquesizeEVG_rank <- as.numeric(ES_imputing$PlaquesizeEVG_rank)
ES_imputing$PlaquesizeGlycc_rank <- as.numeric(ES_imputing$PlaquesizeGlycc_rank)

# Baseline variables (Categorical variables)
## Treat variables as factors
ES_imputing$Gender <- as.factor(ES_imputing$Gender)
ES_imputing$Hospital <- as.factor(ES_imputing$Hospital)
ES_imputing$Hypertension.selfreport <- as.factor(ES_imputing$Hypertension.selfreport)
ES_imputing$Hypertension.drugs <- as.factor(ES_imputing$Hypertension.drugs)
ES_imputing$DiabetesStatus <- as.factor(ES_imputing$DiabetesStatus)
ES_imputing$SmokerStatus <- as.factor(ES_imputing$SmokerStatus)
ES_imputing$risk614 <- as.factor(ES_imputing$risk614)
ES_imputing$Med.anticoagulants <- as.factor(ES_imputing$Med.anticoagulants)
ES_imputing$Med.all.antiplatelet <- as.factor(ES_imputing$Med.all.antiplatelet)
ES_imputing$Med.Statin.LLD <- as.factor(ES_imputing$Med.Statin.LLD)
ES_imputing$CAD_history <- as.factor(ES_imputing$CAD_history)
ES_imputing$PAOD <- as.factor(ES_imputing$PAOD)
ES_imputing$StrokeTIA_history <- as.factor(ES_imputing$StrokeTIA_history)
ES_imputing$Peripheral.interv <- as.factor(ES_imputing$Peripheral.interv)
ES_imputing$Stenosis_ipsilateral <- as.factor(ES_imputing$Stenosis_ipsilateral)
ES_imputing$stenosis_con_bin <- as.factor(ES_imputing$stenosis_con_bin)
ES_imputing$indexsymptoms_latest_4g <- as.factor(ES_imputing$indexsymptoms_latest_4g)
ES_imputing$SourceCD34 <- as.factor(ES_imputing$SourceCD34)
ES_imputing$SourceCD68 <- as.factor(ES_imputing$SourceCD68)
ES_imputing$SourceSMA <- as.factor(ES_imputing$SourceSMA)
ES_imputing$SourceHE <- as.factor(ES_imputing$SourceHE)
ES_imputing$SourceEVG <- as.factor(ES_imputing$SourceEVG)
ES_imputing$epmajor.3years <- as.factor(ES_imputing$epmajor.3years)
ES_imputing$asympt_sympt_latest <-as.factor(ES_imputing$asympt_sympt_latest)
ImpNumVar <- c("Age","ORdate_epoch","systolic", "diastoli", "TC_final_LN", "HDL_final_LN", "LDL_final_LN", "TG_final_LN", "BMI_LN", "GFR_MDRD", "Total_CD34_TissueCount_rank","Total_CD66b_TissueCount_rank","Total_CD68_TissueCount_rank","Total_SMA_TissueCount_rank","Total_HE_TissueCount_rank","Total_EVG_Tissue_rank", "Total_GLYCC_Tissue_rank", "PlaquesizeCD34_rank", "PlaquesizeCD66b_rank", "PlaquesizeCD68_rank", "PlaquesizeSMA_rank", "PlaquesizeHE_rank", "PlaquesizeEVG_rank", "PlaquesizeGlycc_rank", "ep_major_t_3years")

transvar.ln <- c("TC_final_LN", "HDL_final_LN", "LDL_final_LN", "TG_final_LN", "BMI_LN","ep_major_t_3years_LN")

ImpCatVar <- c("Gender", "Hospital","Hypertension.selfreport","risk614","Hypertension.drugs", "Med.anticoagulants", "Med.all.antiplatelet","Med.Statin.LLD","CAD_history","StrokeTIA_history", "PAOD", "SmokerStatus",  "Peripheral.interv", "Stenosis_ipsilateral","stenosis_con_bin", "SourceCD34", "SourceCD68", "SourceSMA", "SourceHE", "SourceEVG","epmajor.3years", "indexsymptoms_latest_4g","IPH.bin", "asympt_sympt_latest")

lapply(ES_imputing[ImpNumVar], function(x) summary(x))
lapply(ES_imputing[ImpCatVar], function(x) summary(x))
lapply(ES_imputing[transvar.ln], function(x) summary(x))
```
# Pattern of Missing Data Exploration
Before moving on to determining the specifics of multiple imputation, we should first explore and see the pattern of missing data in our dataset.
```{r}
#The code below calculates what percent of data is missing
p_missing <- unlist(lapply(ES_imputing, function(x) sum(is.na(x))))/nrow(ES_imputing)
sort(p_missing[p_missing > 0], decreasing = TRUE)

imp.variables <- c("STUDY_NUMBER","Age","ORdate_epoch","systolic", "diastoli", "TC_final_LN", "HDL_final_LN", "LDL_final_LN", "TG_final_LN", "BMI_LN", "GFR_MDRD", "Gender", "Hospital","Hypertension.selfreport","risk614","Hypertension.drugs", "Med.anticoagulants", "Med.all.antiplatelet","Med.Statin.LLD","CAD_history","StrokeTIA_history", "PAOD", "SmokerStatus", "DiabetesStatus",  "Peripheral.interv", "Stenosis_ipsilateral","stenosis_con_bin", "SourceCD34", "SourceCD68", "SourceSMA", "SourceHE", "SourceEVG", "Total_CD34_TissueCount_rank","Total_CD66b_TissueCount_rank","Total_CD68_TissueCount_rank","Total_SMA_TissueCount_rank","Total_HE_TissueCount_rank","Total_EVG_Tissue_rank", "Total_GLYCC_Tissue_rank", "PlaquesizeCD34_rank", "PlaquesizeCD66b_rank", "PlaquesizeCD68_rank", "PlaquesizeSMA_rank", "PlaquesizeHE_rank", "PlaquesizeEVG_rank", "PlaquesizeGlycc_rank", "ep_major_t_3years", "epmajor.3years", "indexsymptoms_latest_4g","ep_major_t_3years_LN","IPH.bin","asympt_sympt_latest")

toimp.variables <- c("HDL_final_LN", "TC_final_LN", "GFR_MDRD", "SmokerStatus", "diastoli", "stenosis_con_bin", "Stenosis_ipsilateral","systolic","LDL_final_LN", "TG_final_LN")
ES_preimp <- subset(ES_imputing[imp.variables])
ES_toimp <- subset(ES_imputing[toimp.variables])
summary(ES_preimp)
summary(ES_toimp)
missing <- md.pattern(ES_preimp)
missing.toimp <- md.pattern(ES_toimp)
write.csv2(missing,'Missing.csv',sep=';',row.names=T,quote=F)
write.csv2(missing.toimp, "Missingtoimp.csv", sep = ";",row.names = T, quote = F)

#At this step, we need to specify distributions for our to-be imputed variables and determine which variable we would like to leave out of the imputation prediction process. We will extract information on the predictor matrix and imputation methods to change them.

#The Predictor Matrix informs us which variables are going to be used to predict a plausible value for variables (1 means a variable is used to predict another variable, 0 otherwise). Since no variable can predict itself, the intersection of one variable with itself in the matrix takes the value 0. We can manually determine if we would like to leave certain variables out of prediction. In this case, I’d like to leave out the "Source" variables for now.

#The mice package assumes a distribution for each variable and imputes missing variables according to that distribution. Hence, it is important to correctly specify each of these distributions. mice automatically chooses distributions for variables. If we would like to change them, we can do it by changing the methods’ characteristics. 

# We run the mice code with 0 iterations 
imp <- mice(ES_preimp, maxit=0)
head(imp$loggedEvents, 2) # loggedEvents = NULL
imp$visitSequence

meth = imp$method
meth
# Extract predictorMatrix and methods of imputation 
predM = imp$predictorMatrix

# Based on: https://www.math.leidenuniv.nl/scripties/MastervanderKruijk.pdf it is better to include log(T(observed event time or censoring time)) and a status indicator as predictors before the imputation takes place. In the AE data log(T) = log(ep_major_t_years) and the status indicator is (ep_major_t_years).
# Ep_major_t_years_LN and epmajor.3years are included in the model.



# Setting values of variables I'd like to leave out to 0 in the predictor matrix
predM[c("STUDY_NUMBER","Age","ORdate_epoch", "BMI_LN","Gender", "Hospital","Hypertension.selfreport","risk614","Hypertension.drugs", "Med.anticoagulants", "Med.all.antiplatelet","Med.Statin.LLD","CAD_history","StrokeTIA_history", "PAOD","DiabetesStatus",  "Peripheral.interv","SourceCD34", "SourceCD68", "SourceSMA", "SourceHE", "SourceEVG", "Total_CD34_TissueCount_rank","Total_CD66b_TissueCount_rank","Total_CD68_TissueCount_rank","Total_SMA_TissueCount_rank","Total_HE_TissueCount_rank","Total_EVG_Tissue_rank", "Total_GLYCC_Tissue_rank", "PlaquesizeCD34_rank", "PlaquesizeCD66b_rank", "PlaquesizeCD68_rank", "PlaquesizeSMA_rank", "PlaquesizeHE_rank", "PlaquesizeEVG_rank", "PlaquesizeGlycc_rank", "ep_major_t_3years", "epmajor.3years", "indexsymptoms_latest_4g","ep_major_t_3years_LN","IPH.bin", "asympt_sympt_latest"),] <- 0 # row: do not predict

predM[,c("STUDY_NUMBER", "SourceCD34", "SourceCD68", "SourceSMA", "SourceHE", "SourceEVG", "Total_CD34_TissueCount_rank","Total_CD66b_TissueCount_rank","Total_CD68_TissueCount_rank","Total_SMA_TissueCount_rank","Total_HE_TissueCount_rank","Total_EVG_Tissue_rank", "Total_GLYCC_Tissue_rank", "PlaquesizeCD34_rank", "PlaquesizeCD66b_rank", "PlaquesizeCD68_rank", "PlaquesizeSMA_rank", "PlaquesizeHE_rank", "PlaquesizeEVG_rank", "PlaquesizeGlycc_rank", "ep_major_t_3years", "Hypertension.drugs", "Med.anticoagulants","IPH.bin","asympt_sympt_latest")] <- 0 # column: do not use as predictor

write.table(predM,file='predictormatrix.csv',sep=';',quote=F,row.names=F)

# If you like, view the first few rows of the predictor matrix
head(predM)

# Specify a separate imputation model for variables of interest 
# Continous variables
pmm <-c("diastoli","GFR_MDRD","HDL_final_LN","TC_final_LN","systolic","LDL_final_LN", "TG_final_LN")
# Dichotomous variables
logreg <-c("stenosis_con_bin")
# Ordered categorical variables 
#polr <-c("Stenosis_ipsilateral")
# Unordered categorical variables
polyreg <- c("SmokerStatus", "Stenosis_ipsilateral")
empty <-c("STUDY_NUMBER","Age","ORdate_epoch", "BMI_LN", "Gender", "Hospital","Hypertension.selfreport","risk614","Hypertension.drugs", "Med.anticoagulants", "Med.all.antiplatelet","Med.Statin.LLD","CAD_history","StrokeTIA_history", "PAOD", "DiabetesStatus",  "Peripheral.interv", "SourceCD34", "SourceCD68", "SourceSMA", "SourceHE", "SourceEVG", "Total_CD34_TissueCount_rank","Total_CD66b_TissueCount_rank","Total_CD68_TissueCount_rank","Total_SMA_TissueCount_rank","Total_HE_TissueCount_rank","Total_EVG_Tissue_rank", "Total_GLYCC_Tissue_rank", "PlaquesizeCD34_rank", "PlaquesizeCD66b_rank", "PlaquesizeCD68_rank", "PlaquesizeSMA_rank", "PlaquesizeHE_rank", "PlaquesizeEVG_rank", "PlaquesizeGlycc_rank", "ep_major_t_3years", "epmajor.3years", "indexsymptoms_latest_4g","IPH.bin")

# Turn their methods matrix into the specified imputation models
meth[pmm] = "pmm"
meth[logreg] ="logreg"
#meth[polr] ="polr"
meth[polyreg]="polyreg"
meth[empty] = ""
meth

# It is convenient to set  m = 5 during model building, and increase  m only after being satisfied with the model for the "final" round of imputation. So if calculation is not prohibitive, we may set m to the average percentage of missing data. The substantive conclusions are unlikely to change as a result of raising  m beyond  m=5.

ES_imputing_dataset <- mice(ES_preimp, m=28, predictorMatrix = predM, method = meth, seed=145, print=FALSE,maxit=30, visitSequence = "monotone", ridge= 1e-03) 

head(ES_imputing_dataset$loggedEvents) 
plot(ES_imputing_dataset,toimp.variables)
class(ES_imputing_dataset)

ES_imputing_complete <- complete(ES_imputing_dataset,action='long',inc=T)
str(ES_imputing_complete[ImpNumVar])
str(ES_imputing_complete$ep_major_t_3years)
str(ES_imputing_complete$epmajor.3years)
str(ES_imputing_complete$Total_CD34_TissueCount_rank)

ES_imputing_complete$epmajor.3years <- as.numeric(ES_imputing_complete$epmajor.3years)
ES_imputing_complete_male <- subset(ES_imputing_complete, Gender == "Male", drop = TRUE)
ES_imputing_complete_female <- subset(ES_imputing_complete, Gender == "Female", drop = TRUE)

ES_complete <- as.mids(ES_imputing_complete)
ES_male <- as.mids(ES_imputing_complete_male)
ES_female <- as.mids(ES_imputing_complete_female)

imp3 <- complete(ES_complete, c(1))
imp3_male <-complete(ES_male, c(1))
imp3_female <-complete(ES_female, c(1))
```
```{r}
# Determining missings after imputation
basetable_impvars = c("Hospital", "Age", "Gender","Hypertension.selfreport","systolic","diastoli","DiabetesStatus","TC_final_LN", "LDL_final_LN", "HDL_final_LN", "TG_final_LN","risk614","Med.Statin.LLD","Hypertension.drugs","Med.all.antiplatelet","Med.anticoagulants","BMI_LN","GFR_MDRD","SmokerStatus","CAD_history","StrokeTIA_history","PAOD","Peripheral.interv","Stenosis_ipsilateral","stenosis_con_bin")

Imputated.tableOne = print(CreateTableOne(vars = basetable_impvars, 
                                         # factorVars = basetable_bin,
                                         # strata = "Gender",
                                         data = imp3, includeNA = FALSE), 
                          nonnormal = c(), missing = TRUE,
                          quote = FALSE, noSpaces = FALSE, showAllLevels = TRUE, explain = TRUE, 
                          format = "fp", 
                          contDigits = 2)[,1:3]
```

# Re-running all the clinical presentation (symptomatic vs asymptomatic), MACE and IPH models with the imputed data
Preparation
```{r}
# Resolving a error (an id statement is required for multi-state models)
ES_imputing$epmajor.3years <- as.numeric(ES_imputing$epmajor.3years)

# Creating male and female subsets of the original dataset
ES_imputing_male <- subset(ES_imputing, Gender == "Male", drop=TRUE)
ES_imputing_female <- subset(ES_imputing, Gender == "Female", drop=TRUE)
```
# Clinical presentation (symptomatic vs asymptomatic) models, imputated data - full cohort
```{r Clinical presentation models, imputated data, full cohort}
# Model 1: Univariable logistic models per plaque characteristic
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_CD34_TissueCount_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD34
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_CD66b_TissueCount_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD66b
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_CD68_TissueCount_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD68
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_SMA_TissueCount_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #SMA
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_HE_TissueCount_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #HE
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_EVG_Tissue_rank, family= "binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #EVG
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_GLYCC_Tissue_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #Glycophorin C

# Model 2: Multivariable logistic models per plaque characteristic, we correct for Plaque size
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_CD34_TissueCount_rank + PlaquesizeCD34_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD34
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_CD66b_TissueCount_rank + PlaquesizeCD66b_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD66b
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_CD68_TissueCount_rank + PlaquesizeCD68_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD68
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_SMA_TissueCount_rank + PlaquesizeSMA_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #SMA
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_HE_TissueCount_rank + PlaquesizeHE_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #HE
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_EVG_Tissue_rank + PlaquesizeEVG_rank, family= "binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #EVG
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #Glycophorin C

# Model 3: Multivariable logistic models per plaque characteristic, we correct for Plaque size and confounders
#CD34
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_CD34_TissueCount_rank + PlaquesizeCD34_rank + ORdate_epoch + Gender + BMI_LN + Peripheral.interv +SourceCD34, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
#CD66b
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_CD66b_TissueCount_rank + PlaquesizeCD66b_rank + Age + Gender + stenosis_con_bin, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD66b
#CD68
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_CD68_TissueCount_rank + PlaquesizeCD68_rank + ORdate_epoch + Age + Gender + SmokerStatus + BMI_LN + CAD_history + SourceCD68, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
#SMA
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_SMA_TissueCount_rank + PlaquesizeSMA_rank + ORdate_epoch + Gender + BMI_LN + Hypertension.drugs + Peripheral.interv + SourceSMA, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) 
#HE
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_HE_TissueCount_rank + PlaquesizeHE_rank + ORdate_epoch + Gender + Hypertension.drugs + stenosis_con_bin + SourceHE, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) 
#EVG
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_EVG_Tissue_rank +  PlaquesizeEVG_rank + Gender + SmokerStatus + BMI_LN + GFR_MDRD + Hypertension.drugs + Peripheral.interv + SourceEVG, family= "binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) 
#Glycophorin C
p1 <- with(ES_complete, glm(asympt_sympt_latest~Total_GLYCC_Tissue_rank+ PlaquesizeGlycc_rank + ORdate_epoch + Gender + SmokerStatus + Hypertension.drugs + CAD_history, data=ExpressScan, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) 
```
# IPH models, imputated data - full cohort
```{r IPH models, imputated data, full cohort}
## Univariable association of Glycophorin and Intraplaque hemorrhage
GLYCC <- with(ES_complete, glm(IPH.bin~Total_GLYCC_Tissue_rank, family="binomial"))
summary(pool(GLYCC), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)

## Multivariable association of Glycophorin and Intraplaque hemorrhage (corrected for plaque size)
GLYCC <- with(ES_complete, glm(IPH.bin~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank, family="binomial"))
summary(pool(GLYCC), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)

### Final logistic regression model
GLYCC <- with(ES_complete, glm(IPH.bin~Total_GLYCC_Tissue_rank+ PlaquesizeGlycc_rank + Hospital + ORdate_epoch + Gender + CAD_history, family="binomial"))
summary(pool(GLYCC), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
```
# MACE models, imputated data - full cohort
```{r MACE models, imputated data, full cohort}
## CD34 MACE models
# Univariable
p1 <- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD34_TissueCount_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD34_TissueCount_rank+PlaquesizeCD34_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: CD34 with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD34_TissueCount_rank + PlaquesizeCD34_rank + Gender + Hypertension.selfreport + TC_final_LN + Med.anticoagulants + Peripheral.interv, data=imp3))
## Multivariable: CD34 with all the imputated data
p3 <- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD34_TissueCount_rank + PlaquesizeCD34_rank + Gender + Hypertension.selfreport + TC_final_LN + Med.anticoagulants + Peripheral.interv))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)


## CD66b MACE models
# Univariable
p1<- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD66b_TissueCount_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD66b_TissueCount_rank + PlaquesizeCD66b_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: CD66b with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD66b_TissueCount_rank + PlaquesizeCD66b_rank + Age + TC_final_LN + HDL_final_LN + Gender + stenosis_con_bin, data=imp3))
## Multivariable: CD66b with all the imputated data
p3 <- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD66b_TissueCount_rank + PlaquesizeCD66b_rank + Age + TC_final_LN + HDL_final_LN + Gender + stenosis_con_bin))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)


## CD68 MACE models
# Univariable
p1<- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD68_TissueCount_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD68_TissueCount_rank + PlaquesizeCD68_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (plaque size + covariates)
## Multivariable: CD68 with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD68_TissueCount_rank + PlaquesizeCD68_rank + Age + Gender + SmokerStatus + TC_final_LN + HDL_final_LN + CAD_history, data=imp3))
## Multivariable: CD68 with all the imputated data
p3 <- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD68_TissueCount_rank + PlaquesizeCD68_rank + Age + Gender + SmokerStatus + TC_final_LN + HDL_final_LN + CAD_history))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)


## SMA MACE models
# Univariable
p1<- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_SMA_TissueCount_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_SMA_TissueCount_rank + PlaquesizeSMA_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: SMA with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_SMA_TissueCount_rank + PlaquesizeSMA_rank + Gender + Hypertension.drugs + Peripheral.interv, data=imp3))
## Multivariable: SMA with all the imputated data
p3 <- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_SMA_TissueCount_rank + PlaquesizeSMA_rank + Gender + Hypertension.drugs + Peripheral.interv))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)


## HE MACE models
# Univariable
p1<- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_HE_TissueCount_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_HE_TissueCount_rank + PlaquesizeHE_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: HE with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_HE_TissueCount_rank + PlaquesizeHE_rank + Gender + Hypertension.drugs + stenosis_con_bin, data=imp3))
## Multivariable: HE with all the imputated data
p3 <- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_HE_TissueCount_rank + PlaquesizeHE_rank + Gender + Hypertension.drugs + stenosis_con_bin))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)


## EVG MACE models
# Univariable
p1<- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_EVG_Tissue_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_EVG_Tissue_rank + PlaquesizeEVG_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: EVG with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_EVG_Tissue_rank + PlaquesizeEVG_rank + Gender + GFR_MDRD + HDL_final_LN + Hypertension.drugs + Peripheral.interv, data=imp3))
## Multivariable: EVG with all the imputated data
p3 <- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_EVG_Tissue_rank + PlaquesizeEVG_rank + Gender + GFR_MDRD + HDL_final_LN + Hypertension.drugs + Peripheral.interv))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)


## Glycophorin C MACE models
# Univariable
p1<- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: Glycophorin C with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank + Gender + Hypertension.selfreport + SmokerStatus + CAD_history, data=imp3))


# Determining which model is best, since hypertension.selfreport and hypertension.drugs are both included in the final model. Based on the AIC. The model including hypertension.selfreport and w/o hypertension.drugs performs best based on the AIC. 
fit <-coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank + Gender + Hypertension.selfreport + SmokerStatus + Hypertension.drugs + CAD_history, data=imp3)
extractAIC(fit)

fit <- coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank + Gender + SmokerStatus + Hypertension.drugs + CAD_history, data=imp3)
extractAIC(fit)

fit <- coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank + Gender + SmokerStatus + Hypertension.selfreport + CAD_history, data=imp3)
extractAIC(fit)

## Multivariable: Glycophorin C with all the imputated data
p3 <- with(ES_complete, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank + Gender + Hypertension.selfreport + SmokerStatus + CAD_history))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
```
# Clinical presentation (symptomatic vs asymptomatic) models, imputated data - male subset
```{r Clinical presentation models, imputated data, male subset}
# Model 1: Univariable logistic models per plaque characteristic
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_CD34_TissueCount_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD34
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_CD66b_TissueCount_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD66b
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_CD68_TissueCount_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD68
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_SMA_TissueCount_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #SMA
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_HE_TissueCount_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #HE
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_EVG_Tissue_rank, family= "binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #EVG
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_GLYCC_Tissue_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #Glycophorin C

# Model 2: Multivariable logistic models per plaque characteristic, we correct for Plaque size
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_CD34_TissueCount_rank + PlaquesizeCD34_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD34
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_CD66b_TissueCount_rank + PlaquesizeCD66b_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD66b
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_CD68_TissueCount_rank + PlaquesizeCD68_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD68
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_SMA_TissueCount_rank + PlaquesizeSMA_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #SMA
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_HE_TissueCount_rank + PlaquesizeHE_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #HE
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_EVG_Tissue_rank + PlaquesizeEVG_rank, family= "binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #EVG
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #Glycophorin C

# Model 3: Multivariable logistic models per plaque characteristic, we correct for Plaque size and confounders
#CD34
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_CD34_TissueCount_rank + PlaquesizeCD34_rank + ORdate_epoch + BMI_LN + Peripheral.interv, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
#CD66b
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_CD66b_TissueCount_rank + PlaquesizeCD66b_rank + Age, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD66b
#CD68
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_CD68_TissueCount_rank + PlaquesizeCD68_rank + ORdate_epoch + Age + BMI_LN + CAD_history, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
#SMA
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_SMA_TissueCount_rank + PlaquesizeSMA_rank + ORdate_epoch + BMI_LN + Hypertension.drugs, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) 
#HE
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_HE_TissueCount_rank + PlaquesizeHE_rank + ORdate_epoch + Hypertension.drugs + SourceHE, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) 
#EVG
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_EVG_Tissue_rank +  PlaquesizeEVG_rank + BMI_LN + GFR_MDRD + Hypertension.drugs + Peripheral.interv + SourceEVG + stenosis_con_bin, family= "binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) 
#Glycophorin C
p1 <- with(ES_male, glm(asympt_sympt_latest~Total_GLYCC_Tissue_rank+ PlaquesizeGlycc_rank + ORdate_epoch + Hypertension.drugs + CAD_history, data=ExpressScan, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) 
```
# IPH models, imputated data - Male subset
```{r IPH models, imputated data, Male subset}
## Univariable association of Glycophorin and Intraplaque hemorrhage
GLYCC <- with(ES_male, glm(IPH.bin~Total_GLYCC_Tissue_rank, family="binomial"))
summary(pool(GLYCC), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)

## Multivariable association of Glycophorin and Intraplaque hemorrhage (corrected for plaque size)
GLYCC <- with(ES_male, glm(IPH.bin~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank, family="binomial"))
summary(pool(GLYCC), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)

### Final logistic regression model
GLYCC <- with(ES_male, glm(IPH.bin~Total_GLYCC_Tissue_rank+ PlaquesizeGlycc_rank + Hospital + ORdate_epoch + CAD_history, family="binomial"))
summary(pool(GLYCC), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
```
# MACE models, imputated data - Male subset
```{r MACE models, imputated data, Male subset}
## CD34 MACE models
# Univariable
p1 <- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD34_TissueCount_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD34_TissueCount_rank+PlaquesizeCD34_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: CD34 with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD34_TissueCount_rank + PlaquesizeCD34_rank + Med.anticoagulants, data=imp3_male))
## Multivariable: CD34 with all the imputated data
p3 <- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD34_TissueCount_rank + PlaquesizeCD34_rank + Med.anticoagulants))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)


## CD66b MACE models
# Univariable
p1<- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD66b_TissueCount_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD66b_TissueCount_rank + PlaquesizeCD66b_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: CD66b with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD66b_TissueCount_rank + PlaquesizeCD66b_rank + Age + HDL_final_LN + DiabetesStatus, data=imp3_male))
## Multivariable: CD66b with all the imputated data
p3 <- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD66b_TissueCount_rank + PlaquesizeCD66b_rank + Age + HDL_final_LN + DiabetesStatus))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)


## CD68 MACE models
# Univariable
p1<- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD68_TissueCount_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD68_TissueCount_rank + PlaquesizeCD68_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (plaque size + covariates)
## Multivariable: CD68 with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD68_TissueCount_rank + PlaquesizeCD68_rank + Age + HDL_final_LN + SmokerStatus +CAD_history, data=imp3_male))
## Multivariable: CD68 with all the imputated data
p3 <- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD68_TissueCount_rank + PlaquesizeCD68_rank + Age + HDL_final_LN + SmokerStatus +CAD_history))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)


## SMA MACE models
# Univariable
p1<- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_SMA_TissueCount_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_SMA_TissueCount_rank + PlaquesizeSMA_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: SMA with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_SMA_TissueCount_rank + PlaquesizeSMA_rank + Hypertension.drugs, data=imp3_male))
## Multivariable: SMA with all the imputated data
p3 <- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_SMA_TissueCount_rank + PlaquesizeSMA_rank + Hypertension.drugs))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)


## HE MACE models
# Univariable
p1<- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_HE_TissueCount_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_HE_TissueCount_rank + PlaquesizeHE_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: HE with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_HE_TissueCount_rank + PlaquesizeHE_rank + Hypertension.drugs, data=imp3_male))
## Multivariable: HE with all the imputated data
p3 <- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_HE_TissueCount_rank + PlaquesizeHE_rank + Hypertension.drugs))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)


## EVG MACE models
# Univariable
p1<- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_EVG_Tissue_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_EVG_Tissue_rank + PlaquesizeEVG_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: EVG with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_EVG_Tissue_rank + PlaquesizeEVG_rank + SmokerStatus + HDL_final_LN + GFR_MDRD + Hypertension.drugs + Med.all.antiplatelet + Peripheral.interv + stenosis_con_bin, data=imp3_male))
## Multivariable: EVG with all the imputated data
p3 <- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_EVG_Tissue_rank + PlaquesizeEVG_rank + SmokerStatus + HDL_final_LN + GFR_MDRD + Hypertension.drugs + Med.all.antiplatelet + Peripheral.interv + stenosis_con_bin))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)

## Glycophorin C MACE models
# Univariable
p1<- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: Glycophorin C with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank + Hypertension.drugs + CAD_history, data=imp3_male))
## Multivariable: Glycophorin C with all the imputated data
p3 <- with(ES_male, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank + Hypertension.drugs + CAD_history))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
```
# Clinical presentation (symptomatic vs asymptomatic) models, imputated data - Female subset
```{r Clinical presentation models, imputated data, Female subset}
# Model 1: Univariable logistic models per plaque characteristic
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_CD34_TissueCount_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD34
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_CD66b_TissueCount_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD66b
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_CD68_TissueCount_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD68
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_SMA_TissueCount_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #SMA
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_HE_TissueCount_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #HE
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_EVG_Tissue_rank, family= "binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #EVG
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_GLYCC_Tissue_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #Glycophorin C

# Model 2: Multivariable logistic models per plaque characteristic, we correct for Plaque size
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_CD34_TissueCount_rank + PlaquesizeCD34_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD34
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_CD66b_TissueCount_rank + PlaquesizeCD66b_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD66b
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_CD68_TissueCount_rank + PlaquesizeCD68_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD68
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_SMA_TissueCount_rank + PlaquesizeSMA_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #SMA
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_HE_TissueCount_rank + PlaquesizeHE_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #HE
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_EVG_Tissue_rank + PlaquesizeEVG_rank, family= "binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #EVG
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #Glycophorin C

# Model 3: Multivariable logistic models per plaque characteristic, we correct for Plaque size and confounders
#CD34
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_CD34_TissueCount_rank + PlaquesizeCD34_rank + ORdate_epoch + TC_final_LN, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
#CD66b
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_CD66b_TissueCount_rank + PlaquesizeCD66b_rank + Age + TC_final_LN + Hypertension.drugs + stenosis_con_bin, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) #CD66b
#CD68
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_CD68_TissueCount_rank + PlaquesizeCD68_rank + ORdate_epoch + Age + TC_final_LN + stenosis_con_bin, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
#SMA
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_SMA_TissueCount_rank + PlaquesizeSMA_rank + ORdate_epoch + SmokerStatus + Peripheral.interv +  stenosis_con_bin + SourceSMA, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) 
#HE
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_HE_TissueCount_rank + PlaquesizeHE_rank + ORdate_epoch + stenosis_con_bin + SourceHE, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) 
#EVG
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_EVG_Tissue_rank +  PlaquesizeEVG_rank + Peripheral.interv + stenosis_con_bin + SourceEVG, family= "binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) 
#Glycophorin C
p1 <- with(ES_female, glm(asympt_sympt_latest~Total_GLYCC_Tissue_rank+ PlaquesizeGlycc_rank + ORdate_epoch, data=ExpressScan, family="binomial"))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) 
```
# IPH models, imputated data - Female subset
```{r IPH models, imputated data, Male subset}
## Univariable association of Glycophorin and Intraplaque hemorrhage
GLYCC <- with(ES_female, glm(IPH.bin~Total_GLYCC_Tissue_rank, family="binomial"))
summary(pool(GLYCC), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)

## Multivariable association of Glycophorin and Intraplaque hemorrhage (corrected for plaque size)
GLYCC <- with(ES_female, glm(IPH.bin~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank, family="binomial"))
summary(pool(GLYCC), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)

### Final logistic regression model
GLYCC <- with(ES_female, glm(IPH.bin~Total_GLYCC_Tissue_rank+ PlaquesizeGlycc_rank + ORdate_epoch + Hypertension.selfreport, family="binomial"))
summary(pool(GLYCC), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
```
# MACE models, imputated data - Female subset
```{r MACE models, imputated data, Female subset}
## CD34 MACE models
# Univariable
p1 <- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD34_TissueCount_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD34_TissueCount_rank+PlaquesizeCD34_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: CD34 with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD34_TissueCount_rank + PlaquesizeCD34_rank + Hospital + ORdate_epoch + Hypertension.selfreport + TC_final_LN + BMI_LN, data=imp3_female))
## Multivariable: CD34 with all the imputated data
p3 <- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD34_TissueCount_rank + PlaquesizeCD34_rank + Hospital + ORdate_epoch + Hypertension.selfreport + TC_final_LN + BMI_LN))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)


## CD66b MACE models
# Univariable
p1<- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD66b_TissueCount_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD66b_TissueCount_rank + PlaquesizeCD66b_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: CD66b with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD66b_TissueCount_rank + PlaquesizeCD66b_rank + Hospital + TC_final_LN + HDL_final_LN + stenosis_con_bin, data=imp3_female))
## Multivariable: CD66b with all the imputated data
p3 <- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD66b_TissueCount_rank + PlaquesizeCD66b_rank + Hospital + TC_final_LN + HDL_final_LN + stenosis_con_bin))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)


## CD68 MACE models
# Univariable
p1<- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD68_TissueCount_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD68_TissueCount_rank + PlaquesizeCD68_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (plaque size + covariates)
## Multivariable: CD68 with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD68_TissueCount_rank + PlaquesizeCD68_rank + Hospital + ORdate_epoch + TC_final_LN + HDL_final_LN + BMI_LN + DiabetesStatus + stenosis_con_bin, data=imp3_female))
## Multivariable: CD68 with all the imputated data
p3 <- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_CD68_TissueCount_rank + PlaquesizeCD68_rank + Hospital + ORdate_epoch + TC_final_LN + HDL_final_LN + BMI_LN + DiabetesStatus + stenosis_con_bin))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)


## SMA MACE models
# Univariable
p1<- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_SMA_TissueCount_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_SMA_TissueCount_rank + PlaquesizeSMA_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: SMA with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_SMA_TissueCount_rank + PlaquesizeSMA_rank  + ORdate_epoch + BMI_LN + stenosis_con_bin, data=imp3_female))
## Multivariable: SMA with all the imputated data
p3 <- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_SMA_TissueCount_rank + PlaquesizeSMA_rank  + ORdate_epoch + BMI_LN + stenosis_con_bin))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)


## HE MACE models
# Univariable
p1<- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_HE_TissueCount_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_HE_TissueCount_rank + PlaquesizeHE_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: HE with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_HE_TissueCount_rank + PlaquesizeHE_rank + ORdate_epoch + Hypertension.drugs + stenosis_con_bin, data=imp3_female))
## Multivariable: HE with all the imputated data
p3 <- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_HE_TissueCount_rank + PlaquesizeHE_rank + ORdate_epoch + Hypertension.drugs + stenosis_con_bin))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)


## EVG MACE models
# Univariable
p1<- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_EVG_Tissue_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_EVG_Tissue_rank + PlaquesizeEVG_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: EVG with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_EVG_Tissue_rank + PlaquesizeEVG_rank + Hospital + BMI_LN + GFR_MDRD + Hypertension.drugs + stenosis_con_bin, data=imp3_female))
## Multivariable: EVG with all the imputated data
p3 <- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_EVG_Tissue_rank + PlaquesizeEVG_rank + Hospital + BMI_LN + GFR_MDRD + Hypertension.drugs + stenosis_con_bin))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)


## Glycophorin C MACE models
# Univariable
p1<- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
# Multivariable (corrected for plaque size)
p1 <- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank))
summary(pool(p1), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
## Multivariable: Glycophorin C with one imputated dataset to get the number of events
summary(coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank + ORdate_epoch + Hospital + Hypertension.drugs + Hypertension.selfreport, data=imp3_female))


# Determining which model is best, since hypertension.selfreport and hypertension.drugs are both included in the final model. Based on the AIC. The model including hypertension.drugs and w/o hypertension.selfreport performs best based on the AIC.
fit <-coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank + ORdate_epoch + Hospital + Hypertension.drugs + Hypertension.selfreport, data=imp3_female)
extractAIC(fit)

fit <- coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank + ORdate_epoch + Hospital + Hypertension.drugs, data=imp3_female)
extractAIC(fit)

fit <- coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank + ORdate_epoch + Hospital + Hypertension.selfreport, data=imp3_female)
extractAIC(fit)

## Multivariable: Glycophorin C with all the imputated data
p3 <- with(ES_female, coxph(Surv(ep_major_t_3years, epmajor.3years)~Total_GLYCC_Tissue_rank + PlaquesizeGlycc_rank + ORdate_epoch + Hospital + Hypertension.drugs))
summary(pool(p3), conf.int=TRUE, conf.level=0.95, exponentiate=TRUE)
```



















